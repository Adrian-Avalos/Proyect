<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icono.ico">
  <link rel="icon" type="image/x-icon" href="icono.ico">
  <title>Calculadora Nutricional Completa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-light">

  <div class="container mt-5 mb-5" id="contenido-pdf">
    <div class="d-flex gap-2 mb-4">
      <a href="menu.html" class="btn btn-secondary flex-fill">üîô Volver al inicio</a>
      <button onclick="generarPDF()" id="btn-pdf" class="btn btn-danger flex-fill">üìÑ Descargar PDF</button>
    </div>
    <h2 class="text-center mb-4">üçΩÔ∏è Calculadora Nutricional Completa</h2>

    <!-- FILTROS -->
    <!-- (el resto del contenido permanece igual y funcional) -->

    <!-- GR√ÅFICO CIRCULAR -->
    <div class="text-center">
      <canvas id="graficoCircular" width="300" height="300"></canvas>
    </div>
  </div>

  <!-- Script externo con los datos -->
  <script src="datos/datos.js"></script>

  <!-- Script principal -->
  <script>
    let alimentosSeleccionados = [];
    let grafico = null;

    function cargarAlimentos(){
      const categoria = document.getElementById('categoria').value;
      const select = document.getElementById('alimento-select');
      select.innerHTML = '<option value="">Seleccion√° un alimento</option>';
      if (!categoria || !baseDatos[categoria]) return;
      Object.keys(baseDatos[categoria]).forEach(alimento => {
        const opt = document.createElement('option');
        opt.value = alimento;
        opt.textContent = alimento;
        select.appendChild(opt);
      });
    }

    function agregarAlimento(){
      const categoria = document.getElementById('categoria').value;
      const alimentoNombre = document.getElementById('alimento-select').value;
      const cantidad = parseFloat(document.getElementById('gramos').value);
      if (!cantidad || cantidad <= 0) {
        alert('Por favor, ingres√° una cantidad v√°lida.');
        return;
      }
      const alimento = baseDatos[categoria][alimentoNombre];
      const factor = cantidad / alimento.medida;
      alimentosSeleccionados.push({ nombre: alimentoNombre, cantidad, unidad: alimento.unidad, ...alimento, factor });
      actualizarTabla();
    }

    function eliminarAlimento(index){
      alimentosSeleccionados.splice(index, 1);
      actualizarTabla();
    }

    function modificarCantidad(index){
      const nuevaCantidad = prompt("Ingres√° la nueva cantidad:", alimentosSeleccionados[index].cantidad);
      if (nuevaCantidad && !isNaN(nuevaCantidad) && nuevaCantidad > 0) {
        alimentosSeleccionados[index].cantidad = parseFloat(nuevaCantidad);
        alimentosSeleccionados[index].factor = alimentosSeleccionados[index].cantidad / alimentosSeleccionados[index].medida;
        actualizarTabla();
      }
    }

    function actualizarTabla(){
      const tabla = document.getElementById('tabla-alimentos');
      tabla.innerHTML = '';
      alimentosSeleccionados.forEach((a, i) => {
        tabla.innerHTML += `<tr>
          <td>${a.nombre}</td>
          <td>${a.cantidad} ${a.unidad}</td>
          <td>${(a.calorias*a.factor).toFixed(1)}</td>
          <td>${(a.hc*a.factor).toFixed(1)}</td>
          <td>${(a.proteinas*a.factor).toFixed(1)}</td>
          <td>${(a.grasas*a.factor).toFixed(1)}</td>
          <td>${(a.na*a.factor).toFixed(1)}</td>
          <td>${(a.k*a.factor).toFixed(1)}</td>
          <td>${(a.p*a.factor).toFixed(1)}</td>
          <td>${(a.ca*a.factor).toFixed(1)}</td>
          <td>${(a.fe*a.factor).toFixed(1)}</td>
          <td>${(a.colest*a.factor).toFixed(1)}</td>
          <td>${(a.purinas*a.factor).toFixed(1)}</td>
          <td>${(a.fibra*a.factor).toFixed(1)}</td>
          <td>${(a.agua*a.factor).toFixed(1)}</td>
          <td>${(a.afolic*a.factor).toFixed(1)}</td>
          <td>
            <button class="btn btn-warning btn-sm" onclick="modificarCantidad(${i})">‚úèÔ∏è</button>
            <button class="btn btn-danger btn-sm" onclick="eliminarAlimento(${i})">‚ùå</button>
          </td>
        </tr>`;
      });
      calcularTotales();
    }

    function calcularTotales(){
      const totales = { calorias:0, hc:0, proteinas:0, grasas:0, na:0, k:0, p:0, ca:0, fe:0, colest:0, purinas:0, fibra:0, agua:0, afolic:0 };
      alimentosSeleccionados.forEach(a => {
        for(let key in totales){
          const valor = a[key];
          totales[key] += (valor != null ? valor : 0) * a.factor;
        }
      });
      document.getElementById('totales').textContent =
        `Totales: ${totales.calorias.toFixed(1)} cal | ${totales.hc.toFixed(1)}g HC | ${totales.proteinas.toFixed(1)}g Prot | ${totales.grasas.toFixed(1)}g Grasas | ` +
        `${totales.na.toFixed(1)}mg Na | ${totales.k.toFixed(1)}mg K | ${totales.p.toFixed(1)}mg P | ${totales.ca.toFixed(1)}mg Ca | ${totales.fe.toFixed(1)}mg Fe | ` +
        `${totales.colest.toFixed(1)}mg Colest | ${totales.purinas.toFixed(1)}mg Purinas | ${totales.fibra.toFixed(1)}g Fibra | ${totales.agua.toFixed(1)}g Agua | ${totales.afolic.toFixed(1)}¬µg A.F√≥lic`;

      actualizarGrafico(totales);
    }

    function actualizarGrafico(totales) {
      const ctx = document.getElementById('graficoCircular').getContext('2d');
      const data = [totales.hc, totales.proteinas, totales.grasas];
      const labels = ['Carbohidratos', 'Prote√≠nas', 'Grasas'];

      if (grafico) grafico.destroy();
      grafico = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{ data, backgroundColor: ['#ffc107', '#198754', '#dc3545'] }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function filtrarAlimentos(){
      cargarAlimentos();
    }

    function generarPDF() {
      const element = document.getElementById('contenido-pdf');
      const opt = {
        margin: 0.5,
        filename: 'reporte-nutricional.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }
  </script>

</body>
</html>
